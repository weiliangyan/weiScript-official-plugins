name: Build and Release SuperRPG Plugins

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [16.x, 18.x]
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Build plugin packages
      run: npm run build
      
    - name: Verify packages
      run: npm run verify
      
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: plugin-packages-node-${{ matrix.node-version }}
        path: packages/
        retention-days: 30
        
    - name: Upload build report
      uses: actions/upload-artifact@v4
      with:
        name: build-report-node-${{ matrix.node-version }}
        path: packages/build-report.json
        retention-days: 30

  test:
    runs-on: ubuntu-latest
    needs: build
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: plugin-packages-node-18.x
        path: packages/
        
    - name: Test installation script
      run: |
        node install.js --list
        echo "Installation script test completed"

  release:
    runs-on: ubuntu-latest
    needs: [build, test]
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Build packages
      run: npm run build
      
    - name: Create release archive
      run: |
        tar -czf weiscript-plugins-${{ github.ref_name }}.tar.gz packages/ src/ install.js package-index.json README.md
        
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          weiscript-plugins-${{ github.ref_name }}.tar.gz
          packages/*.zip
        body: |
          ## SuperRPG JavaScript æ’ä»¶åŒ… ${{ github.ref_name }}
          
          ### ğŸ“¦ åŒ…å«çš„æ’ä»¶æ¨¡å—
          - weiScript-core - æ ¸å¿ƒ API å’ŒæœåŠ¡æ¡†æ¶
          - weiScript-database - æ•°æ®åº“æœåŠ¡æ¨¡å—
          - weiScript-player - ç©å®¶æ•°æ®ç®¡ç†æ¨¡å—
          - weiScript-profession - èŒä¸šç³»ç»Ÿæ¨¡å—
          - weiScript-skill - æŠ€èƒ½ç³»ç»Ÿæ¨¡å—
          - weiScript-equipment - è£…å¤‡ç³»ç»Ÿæ¨¡å—
          - weiScript-quest - ä»»åŠ¡ç³»ç»Ÿæ¨¡å—
          - weiScript-economy - ç»æµç³»ç»Ÿæ¨¡å—
          - weiScript-social - ç¤¾äº¤ç³»ç»Ÿæ¨¡å—
          
          ### ğŸš€ å®‰è£…æ–¹æ³•
          ```bash
          # ä¸‹è½½å¹¶è§£å‹
          wget https://github.com/weiliangyan/weiScript-official-plugins/releases/download/${{ github.ref_name }}/weiscript-plugins-${{ github.ref_name }}.tar.gz
          tar -xzf weiscript-plugins-${{ github.ref_name }}.tar.gz
          
          # æ ‡å‡†å®‰è£…
          node install.js --set standard
          ```
          
          ### ğŸ”„ ç‰ˆæœ¬å…¼å®¹æ€§
          - Minecraft: 1.12.2 - 1.21+
          - Java: 8+
          - weiScript: 1.0.0+
          
          ### ğŸ“‹ æ›´æ–°æ—¥å¿—
          è¯·æŸ¥çœ‹ [CHANGELOG.md](https://github.com/weiliangyan/weiScript-official-plugins/blob/main/CHANGELOG.md) äº†è§£è¯¦ç»†æ›´æ–°å†…å®¹ã€‚
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  update-index:
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: plugin-packages-node-18.x
        path: packages/
        
    - name: Update package index
      run: |
        # æ›´æ–°åŒ…ç´¢å¼•ä¸­çš„ä¸‹è½½é“¾æ¥å’Œå…ƒæ•°æ®
        node -e "
        const fs = require('fs');
        const path = require('path');
        
        // è¯»å–åŒ…ç´¢å¼•
        const indexPath = 'package-index.json';
        const index = JSON.parse(fs.readFileSync(indexPath, 'utf8'));
        
        // æ›´æ–°å…ƒæ•°æ®
        index.metadata.last_updated = new Date().toISOString();
        
        // æ›´æ–°ä¸‹è½½é“¾æ¥
        for (const [packageName, packageInfo] of Object.entries(index.packages)) {
          packageInfo.download_url = \`https://raw.githubusercontent.com/weiliangyan/weiScript-official-plugins/main/packages/\${packageName}.zip\`;
        }
        
        // å†™å›æ–‡ä»¶
        fs.writeFileSync(indexPath, JSON.stringify(index, null, 2));
        console.log('Package index updated');
        "
        
    - name: Commit updated index
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add package-index.json
        git diff --staged --quiet || git commit -m "chore: update package index [skip ci]"
        git push
